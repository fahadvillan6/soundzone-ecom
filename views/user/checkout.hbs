<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="/css/checkout.css">
{{!-- <div class="breadcumb_area bg-img" style="background-image: url(img/bg-img/breadcumb.jpg);"> --}}
    <div class="container mt-5">
        <div class="row align-items-center">
            <div class="col-12 mt-5">
                <div class="page-title text-center">
                    <h2>Checkout</h2>
                </div>
            </div>


        </div>
    </div>
</div>
<!-- ##### Breadcumb Area End ##### -->

{{!-- < !-- ##### Checkout Area Start ##### --> --}}

    <div class="checkout_area section-padding-80">
        <div class="container">
            <div class="row">

                <div class="col-12 col-md-6">
                    <div class="checkout_details_area mt-50 clearfix">

                        <div class="cart-page-heading mb-30">
                            <h5>Billing Address</h5>
                        </div>

                        <button type="button" class="mt-1 flex-c-m stext-101  cl0 size-115 bg3 bor1 hov-btn3 "
                            data-toggle="modal" data-target="#exampleModal">
                            Add New Address
                        </button>
                        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog"
                            aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLabel">Add New Address</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <form action="/add-address" method="post">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="first_name">First Name
                                                        <span>*</span></label>
                                                    <input type="text" class="form-control" id="first_name" value=""
                                                        required name="FirstName">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="last_name">Last Name <span>*</span></label>
                                                    <input type="text" class="form-control" id="last_name" value=""
                                                        required name="LastName">
                                                </div>
                                                <div class="col-12 mb-3">
                                                    <label for="phone_number">Phone No
                                                        <span>*</span></label>
                                                    <input type="tel" class="form-control" id="phone_number" min="0"
                                                        value="" name="Phone" required>
                                                </div>
                                                <div class="col-12 mb-4">
                                                    <label for="email_address">Email Address
                                                        <span>*</span></label>
                                                    <input type="email" class="form-control" id="email_address" value=""
                                                        name="Email" required>
                                                </div>
                                                <div class="col-12 mb-3">
                                                    <label for="company">Company/House Name</label>
                                                    <input type="text" class="form-control" id="company" value=""
                                                        name="House" required>
                                                </div>

                                                <div class="col-12 mb-3">
                                                    <label for="street_address">Address
                                                        <span>*</span></label>
                                                    <textarea type="text" class="form-control mb-3" id="street_address"
                                                        value="" name="Address" required></textarea>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="postcode">Postcode <span>*</span></label>
                                                    <input type="text" class="form-control" id="postcode" value=""
                                                        name="Pincode" required>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="city">Town/City <span>*</span></label>
                                                    <input type="text" class="form-control" id="city" value=""
                                                        name="City" required>
                                                </div>
                                                <div class="col-12 mb-3">
                                                    <label for="state">State <span>*</span></label>
                                                    <input type="text" class="form-control" id="state" value=""
                                                        name="State" required>
                                                </div>
                                            </div>

                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Save changes</button>
                                    </div>
                                </div>
                                </form>
                            </div>
                        </div>
                        <br>

                        {{!-- <form action="/placeorder" id="checkout-form" method="post"> --}}
                            {{#each Addresses}}
                            <div id="accordion" role="tablist" class="mb-4">
                                <div class="card">
                                    <div class="card-header" role="tab" id="headingOne">


                                        <label for="Address">
                                            <input type="radio" class="form-check-input program_checkbox" id="Address"
                                                value="{{this.id}}" style="margin-top: 4px;" name="Address" checked>
                                            {{!-- <input type="radio" name="Address" class="custom-control-input"
                                                id="customCheck2" style="font-family: Poppins-Regular ;"> --}}
                                            <a data-toggle="collapse" href="#collapse{{@index}}" aria-expanded="false"
                                                aria-controls="collapseOne" style="margin-left:5px;margin-top: 5px;">
                                                {{this.FirstName}}</a>
                                        </label>

                                    </div>

                                    <div id="collapse{{@index}}" class="collapse" role="tabpanel"
                                        aria-labelledby="headingOne" data-parent="#accordion">
                                        <div class="card-body">
                                            <p>{{this.House}}</p>
                                            <p> {{this.Address}}</p>
                                            <P>{{this.City}} &nbsp; {{this.State}} &nbsp;{{this.Pincode}}</P>
                                            <p>{{this.Phone}} </p>
                                        </div>
                                    </div>

                                </div>



                            </div>
                            {{/each}}
                    </div>
                </div>

                <div class="col-12 col-md-6 col-lg-5 ml-lg-auto">
                    <div class="order-details-confirmation">

                        <div class="cart-page-heading">
                            <h5>Your Order</h5>

                        </div>
                        <div style="height: 250px;width: 400px;overflow:scroll;overflow-x: hidden;">
                            {{!-- <input hidden name="Products" value="{{Products}}"> --}}
                            {{#each Products}}

                            <div class="">
                                <div class="d-flex">
                                    <img class="ms-1" src="/products/{{this.Items.Images.[0]}}"
                                        style="height: 80px;width:100px">
                                    <h6>{{this.Items.Name}}</h6>
                                    <div style="float: right;d-flex">
                                        <br><br>
                                        <i class="text-center me-4 j mb-1">{{this.Qty}}</i>
                                        <i>X</i>
                                        <i class="text-center">{{this.Items.SellingPrice}}</i>
                                    </div>
                                </div>
                                {{!-- <div style="" class="d-flex"> --}}
                                    {{!-- </div> --}}
                                <hr>
                            </div>
                            {{/each}}
                        </div>

                        <ul id="dynamicArea" class=" order-details-form mb-2">
                            <div class="d-flex flex-w flex-m m-r-20 m-tb-5">
                                <input class="stext-104 cl2 plh4 size-117 bor13 p-lr-20 m-r-10 m-tb-5" type="text"
                                    name="coupon" id="couponfield" placeholder="Coupon Code" />

                                <div class="">
                                    <button class="btn" onclick="couponcheck()">Apply </button>
                                </div>

                            </div>{{!-- <li><button><span>Apply a Coupon</span></button></li> --}}
                            {{!-- <li><span>Product</span> <span>Total</span></li>
                            <li><span>Cocktail Yellow dress</span> <span>$59.90</span></li> --}}
                            <input hidden id="Subtotal" name="Subtotal" value="{{subtotal}}">
                            <input hidden id="Discount" name="Discount" value="{{Discount}}">
                            <input hidden id="Total" name="Total" value="{{Total}}">
                            <li><span>Subtotal</span> <span>{{subtotal}}</span></li>
                            <li><span>Coupon Discount</span><span id="Discountfield">{{Discount}}</span></li>
                            <li><span>Total</span> <span id="Totalfield">{{Total}}</span></li>
                        </ul>
                        <div class="custom-control custom-checkbox mb-2">
                            <h6 class="mb-0">
                                <input type="radio" name="Payment" class="custom-control-input" id="customCheck1"
                                    style="font-family: Poppins-Regular ;" value="RazorPay" checked>
                                <label class="custom-control-label" for="customCheck1">Razor
                                    Pay (Cards/Upi/NetBanking)</label>
                            </h6>
                        </div>
                        <br>
                        <div class="custom-control custom-checkbox mb-4">
                            <h6 class="mb-0">
                                <input type="radio" name="Payment" class="custom-control-input" id="customCheck2"
                                    style="font-family: Poppins-Regular ;" value="COD">
                                <label class="custom-control-label" for="customCheck2">Cash On
                                    Delivery</label>
                            </h6>
                        </div>

                        <button onclick="checkout()"
                            class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
                            Place Order
                        </button>
                    </div>

                </div>
                {{!-- </form> --}}
            </div>
        </div>


    </div>
    {{!--
    <script src="../vendor/sweetalert/sweetalert.min.js"></script> --}}
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>


        function checkout() {
            let Payment = $('input[name="Payment"]:checked').val()
            let Address = $('input[name="Address"]:checked').val()

            if (Address === undefined) {
                swal("oops!", "Please Selct any Address!", "error");
            }
            else {
                let Total = document.getElementById("Total").value
                const Subtotal = document.getElementById("Subtotal").value
                let Discount = document.getElementById("Discountfield").value
                $.ajax({
                    url: "/placeorder",
                    data: {
                        Payment: Payment,
                        Address: Address,
                        Total,
                        Subtotal,
                        Discount,
                        //   Qty: qty,
                        // val: val,
                    },

                    method: "post",
                    success: (response) => {
                        console.log('ggg')
                        if (response.cod) {
                            console.log("idfjsoi");
                            location.assign(`/order-confirm/${response.data._id}`);
                            //   alert(a)
                        }
                        else {
                            razorpayPayment(response)
                        }
                    },
                })
            }
        }
        function razorpayPayment(data) {
            var options = {
                "key": "rzp_test_Uxh9u0c2EwOZ14", // Enter the Key ID generated from the Dashboard
                "amount": data.amount,  // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                "currency": "INR",
                "name": "AudioZone",
                "description": "Test Transaction",
                "image": "https://example.com/your_logo",
                "order_id": data.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                "handler": function (response) {
                    // alert(response.razorpay_payment_id);
                    // alert(response.razorpay_order_id);
                    // alert(response.razorpay_signature)
                    verifyPayment(response, data);
                },
                "prefill": {
                    "name": "",
                    "email": "",
                    "contact": ""
                },
                "notes": {
                    "address": "Razorpay Corporate Office"
                },
                "theme": {
                    "color": "#3399cc"
                }
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();

        }
        function verifyPayment(payment, order) {
            axios
                .post("/admin/verifyPayment", {
                    payment,
                    order,

                })
                .then((response) => {
                    // console.log(response.data.id, response.data.status)
                    if (response.status) {
                        console.log(response)
                        location.assign(`/order-confirm/${response.data.id}`);
                        console.log(response.data.id, response.status)
                        // window.location.href = `/order-confirm/${data._id}`
                    }
                });

        }



    </script>
    <script>
        function couponcheck() {
            let check = document.getElementById("couponfield").value;
            let Subtotal = document.getElementById("Subtotal").value;

            axios.post("/verifycoupon", {
                check,
                Subtotal,
            }).then((response) => {
                console.log(response)
                swal(response.data.message);
                if (response.data.status) {
                    updatePrice(response.data.Discount)
                }

            })
            // $("#dynamicArea").load(location.href + " #dynamicArea")

        }
        function updatePrice(discount) {
            console.log(discount)
            document.getElementById('Discountfield').innerHTML = discount;
            let total = document.getElementById("Total").value;
            let Total = total - discount;
            document.getElementById('Total').value = Total;
            document.getElementById('Totalfield').innerHTML = Total;
            console.log(document.getElementById('Total').value)




        }
    </script>